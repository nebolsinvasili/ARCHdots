#!/usr/bin/env bash
# =========================================================
# üß© setup-autologin.sh ‚Äî –∫—Ä–∞—Å–∏–≤—ã–π –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –Ω–∞—Å—Ç—Ä–æ–π—â–∏–∫ –∞–≤—Ç–æ–ª–æ–≥–∏–Ω–∞ –Ω–∞ TTY1
# =========================================================
set -euo pipefail

# === –¶–≤–µ—Ç–∞ –∏ —Å—Ç–∏–ª–∏ ===
RED="\033[0;31m"
GREEN="\033[0;32m"
YELLOW="\033[0;33m"
BLUE="\033[0;34m"
BOLD="\033[1m"
RESET="\033[0m"

info()  { printf "${BLUE}‚ûú${RESET} %b\n" "$1"; }
ok()    { printf "${GREEN}‚úî${RESET} %b\n" "$1"; }
warn()  { printf "${YELLOW}‚ö†${RESET} %b\n" "$1"; }
err()   { printf "${RED}‚úñ${RESET} %b\n" "$1"; }

# === –ü—Ä–æ–≤–µ—Ä–∫–∞ root ===
if [[ $EUID -ne 0 ]]; then
  err "–¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø—É—Å–∫ –æ—Ç root. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ:"
  echo "   sudo $0"
  exit 1
fi

# === –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ ===
printf "\n${BOLD}üß© –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–ª–æ–≥–∏–Ω–∞ –≤ –∫–æ–Ω—Å–æ–ª–∏ (TTY1)${RESET}\n"
printf "–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É –±–µ–∑ –∑–∞–ø—Ä–æ—Å–∞ –ø–∞—Ä–æ–ª—è.\n\n"

# === –í—ã–±–æ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ===
info "–î–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:"
mapfile -t users < <(awk -F: '$3 >= 1000 && $1 != "nobody" {print $1}' /etc/passwd)

for i in "${!users[@]}"; do
  printf "  %2d) üë§ %s\n" "$((i+1))" "${users[$i]}"
done

printf "\n"
read -r -p "üëâ –í—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è [1]: " choice
choice=${choice:-1}

if ! [[ "$choice" =~ ^[0-9]+$ ]] || (( choice < 1 || choice > ${#users[@]} )); then
  err "–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤—ã–±–æ—Ä!"
  exit 1
fi

USERNAME="${users[$((choice-1))]}"
ok "–í—ã–±—Ä–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å: ${BOLD}${USERNAME}${RESET}"

# === –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø—É—Ç–µ–π ===
DIR="/etc/systemd/system/getty@tty1.service.d"
FILE="$DIR/override.conf"

printf "\n${BOLD}‚öôÔ∏è  –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤:${RESET}\n"
printf "–§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏: ${BOLD}${FILE}${RESET}\n"

# === –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –±—ç–∫–∞–ø–∞ ===
if [[ -f "$FILE" ]]; then
  warn "–ù–∞–π–¥–µ–Ω —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ñ–∞–π–ª override.conf."
  read -r -p "–°–¥–µ–ª–∞—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é? [Y/n]: " do_backup
  do_backup=${do_backup:-Y}

  if [[ "$do_backup" =~ ^([yY]|[yY][eE][sS])$ ]]; then
    backup_file="${FILE}.bak.$(date +%F-%H%M%S)"
    cp "$FILE" "$backup_file"
    ok "–ë—ç–∫–∞–ø —Å–æ—Ö—Ä–∞–Ω—ë–Ω –≤ ${backup_file}"
  else
    warn "–ë—ç–∫–∞–ø –ø—Ä–æ–ø—É—â–µ–Ω."
  fi
fi

# === –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –∑–∞–ø–∏—Å—å—é ===
printf "\n${YELLOW}üöÄ –î–µ–π—Å—Ç–≤–∏—è:${RESET}\n"
echo " - –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞: $DIR"
echo " - –ó–∞–ø–∏—Å—å override.conf –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${USERNAME}"
echo " - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ systemd-—é–Ω–∏—Ç getty@tty1.service"
read -r -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? [Y/n]: " confirm
confirm=${confirm:-Y}
if [[ ! "$confirm" =~ ^([yY]|[yY][eE][sS])$ ]]; then
  err "–û–ø–µ—Ä–∞—Ü–∏—è –æ—Ç–º–µ–Ω–µ–Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º."
  exit 0
fi

# === –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—Ç–∞–ª–æ–≥–∞ ===
mkdir -p "$DIR"

# === –ó–∞–ø–∏—Å—å –Ω–æ–≤–æ–≥–æ override.conf ===
cat > "$FILE" <<EOF
[Service]
ExecStart=
ExecStart=-/usr/bin/agetty --autologin ${USERNAME} --noclear %I \$TERM
EOF

ok "–§–∞–π–ª –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —É—Å–ø–µ—à–Ω–æ –∑–∞–ø–∏—Å–∞–Ω: ${FILE}"

# === –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π ===
info "–ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞—é systemd..."
systemctl daemon-reload
# systemctl restart getty@tty1.service
ok "–ê–≤—Ç–æ–ª–æ–≥–∏–Ω –≤–∫–ª—é—á—ë–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${BOLD}${USERNAME}${RESET}"

# === –ò—Ç–æ–≥ ===
printf "\n${GREEN}‚úÖ –ì–æ—Ç–æ–≤–æ!${RESET}\n"
echo "–¢–µ–ø–µ—Ä—å –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Å–∏—Å—Ç–µ–º—ã –ø—Ä–æ–∏–∑–æ–π–¥—ë—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ –≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è ${USERNAME}."
echo "–í—ã –º–æ–∂–µ—Ç–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–±–æ—Ç—É –±–µ–∑ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∏: –Ω–∞–∂–º–∏—Ç–µ ${BOLD}Ctrl+Alt+F1${RESET} –∏ –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ TTY1."
printf "\n"

exit 0
